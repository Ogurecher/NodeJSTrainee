<!DOCTYPE html>
<html>
    <head>
        <title>Available users</title>
        <script type="systemjs-importmap">
            {
                "imports": {
                    "debug": "https://unpkg.com/debug@4.1.1/dist/debug.js",
                    "react": "https://unpkg.com/react@16/umd/react.development.js",
                    "react-dom": "https://unpkg.com/react-dom@16/umd/react-dom.development.js"
                }
            }
        </script>
        <script src="https://unpkg.com/systemjs@6.2.5/dist/system.js"></script>
        <script src="https://unpkg.com/systemjs@6.2.5/dist/extras/named-register.js"></script>
        <script type="text/javascript" src="errorHandling.js"></script>
        <script type="text/javascript" src="index.js"></script>
    </head>
    <body>
        <div id="root"></div>
        <div id="call_button_root"></div>
        <div id="call_info_root"></div>

        <script type="text/javascript">
            (async () => {
                await System.import('./errorHandling.js');
                await System.import('./index.js');
                const { subscribe, getOnlineUsers } = await System.import('index');
                const { fireCreateCallRequest } =  await System.import('fireCreateCallRequest');
                const { hangUpCall } =  await System.import('hangUpCall');
                const { renderButton } = await System.import('reactRenderer');

                renderButton();

                window.fireCreateCallRequest = fireCreateCallRequest;
                window.hangUpCall = hangUpCall;

                subscribe({ func: getOnlineUsers });
            })();
        </script>

        <video id="selfView" autoplay></video>
        <video id="remoteView" autoplay></video>

        <script>
            // handles JSON.stringify/parse
            const selfView = document.getElementById("selfView");
            const remoteView = document.getElementById("remoteView");
            
            const constraints = {/*audio: true,*/ 
                video: {
                    mandatory: {
                        minWidth: 640,
                        maxWidth: 640,
                        minHeight: 360,
                        maxHeight: 360
                    }
                }
            };
            const signaling = new WebSocket('wss://myhuebot.ngrok.io/websocket');
            const configuration = {iceServers: [{urls: 'stun:stun.l.google.com:19302'}]};
            const pc = new RTCPeerConnection(configuration);
    
            // send any ice candidates to the other peer
            pc.onicecandidate = ({candidate}) => signaling.send(JSON.stringify(candidate));
    
            // let the "negotiationneeded" event trigger offer generation
            pc.onnegotiationneeded = async () => {
                try {
                    await pc.setLocalDescription(await pc.createOffer());
                    
                    // send the offer to the other peer
                    signaling.send(JSON.stringify(pc.localDescription));
                } catch (err) {
                    console.error(err);
                }
            };
    
            // once remote track media arrives, show it in remote video element
            pc.ontrack = (event) => {
                // don't set srcObject again if it is already set.
                if (remoteView.srcObject) return;
                remoteView.srcObject = event.streams[0];
            };
    
            // call start() to initiate
            async function start() {
                try {
                    // get local stream, show it in self-view and add it to be sent
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    stream.getTracks().forEach((track) => pc.addTrack(track, stream));
                    selfView.srcObject = stream;
                } catch (err) {
                    console.error(err);
                }
            }
    
            /*signaling.onmessage = function(event) {
                data = JSON.parse(event.data);
                console.debug("WebSocket message received:", event);
            };*/
    
            signaling.onmessage = async (event) => {
                try {
                    data = JSON.parse(event.data);
    
                    if (data.type) {
                        // if we get an offer, we need to reply with an answer
                        if (data.type === 'offer') {
                            await pc.setRemoteDescription(data);
                            const stream = await navigator.mediaDevices.getUserMedia(constraints);
                            stream.getTracks().forEach((track) => pc.addTrack(track, stream));
                            await pc.setLocalDescription(await pc.createAnswer());
    
                            signaling.send(JSON.stringify(pc.localDescription));
                        } else if (data.type === 'answer') {
                            await pc.setRemoteDescription(data);
                        } else {
                            console.log('Unsupported SDP type.');
                        }
                    } else if (data.candidate) {
                        await pc.addIceCandidate(data);
                    }
                } catch (err) {
                    console.error(err);
                }
            };
    
            start();
        </script>
    </body>
</html>